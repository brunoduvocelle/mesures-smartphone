<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Expert Sensor Scan - Ultra Precision</title>
    <style>
        :root {
            --bg: #020617; --card: #0f172a; --accent: #38bdf8;
            --text: #f8fafc; --dim: #64748b; --neon: #22d3ee;
        }
        body { background: var(--bg); color: var(--text); font-family: 'Consolas', monospace; margin: 0; padding: 15px; font-size: 13px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .instrument { 
            background: var(--card); border: 1px solid #1e293b; padding: 12px; border-radius: 8px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        .full { grid-column: 1 / -1; }
        .label { color: var(--accent); font-size: 10px; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
        .val { color: var(--neon); font-size: 16px; font-variant-numeric: tabular-nums; }
        .sub { font-size: 9px; color: var(--dim); margin-top: 4px; }
        #btn-start { 
            background: linear-gradient(45deg, #0ea5e9, #22d3ee); color: #000; 
            border: none; padding: 20px; width: 100%; font-weight: 900; 
            border-radius: 8px; cursor: pointer; margin-bottom: 15px;
        }
        video { display: none; } /* Caché, utilisé pour le calcul de lumière */
    </style>
</head>
<body>

    <button id="btn-start">ACTIVER L'AUDIT DE PRÉCISION</button>
    
    <div class="grid" id="ui">
        <div class="instrument full">
            <div class="label">Boussole & Nord Magnétique</div>
            <div class="val" id="v-compass">--°</div>
            <div class="sub" id="v-compass-type">En attente...</div>
        </div>

        <div class="instrument">
            <div class="label">Magnétomètre (Brut)</div>
            <div class="val" id="v-mag">X:0 Y:0 Z:0</div>
            <div class="sub">Unité: Microteslas (µT)</div>
        </div>

        <div class="instrument">
            <div class="label">Luminosité (Lux)</div>
            <div class="val" id="v-lux">--</div>
            <div class="sub" id="v-lux-source">Capteur: Standard</div>
        </div>

        <div class="instrument">
            <div class="label">Accéléromètre</div>
            <div class="val" id="v-acc">0, 0, 0</div>
        </div>

        <div class="instrument">
            <div class="label">Rotation</div>
            <div class="val" id="v-gyro">0, 0, 0</div>
        </div>
    </div>

    <video id="video-hidden" autoplay playsinline></video>
    <canvas id="canvas-hidden" style="display:none;"></canvas>

<script>
{
    const db = {};
    const video = document.getElementById('video-hidden');
    const canvas = document.getElementById('canvas-hidden');
    const ctx = canvas.getContext('2d');

    // 1. GESTION DE LA LUMIÈRE (Double méthode)
    const initLight = async () => {
        if ('AmbientLightSensor' in window) {
            try {
                const sensor = new AmbientLightSensor({frequency: 10});
                sensor.onreading = () => {
                    db['lux'] = Math.round(sensor.illuminance);
                    db['lux-src'] = "Matériel: AmbientLightSensor";
                };
                sensor.start();
            } catch(e) { setupCameraLux(); }
        } else {
            setupCameraLux();
        }
    };

    // Analyseur de luminance via caméra (Finesse logicielle)
    const setupCameraLux = async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = stream;
            db['lux-src'] = "Matériel: Analyse Optique (Caméra)";
            
            setInterval(() => {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.width = 64; canvas.height = 64;
                    ctx.drawImage(video, 0, 0, 64, 64);
                    const data = ctx.getImageData(0, 0, 64, 64).data;
                    let brightness = 0;
                    for (let i = 0; i < data.length; i += 4) {
                        brightness += (0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2]);
                    }
                    db['lux'] = Math.round((brightness / (data.length / 4)));
                }
            }, 500);
        } catch(e) { db['lux'] = "Accès Caméra Refusé"; }
    };

    // 2. GESTION MAGNÉTO / BOUSSOLE (Triple méthode)
    const initMagneto = () => {
        // Tentative API Moderne
        if ('Magnetometer' in window) {
            try {
                const mag = new Magnetometer({frequency: 60});
                mag.onreading = () => {
                    db['mag'] = `${mag.x.toFixed(1)} ${mag.y.toFixed(1)} ${mag.z.toFixed(1)}`;
                };
                mag.start();
            } catch(e) {}
        }

        // Boussole & Fallback Orientation
        window.addEventListener('deviceorientationabsolute', handleOrient, true);
        window.addEventListener('deviceorientation', handleOrient, true);
    };

    const handleOrient = (e) => {
        let heading = 0;
        if (e.webkitCompassHeading) {
            heading = e.webkitCompassHeading; // iOS
            db['compass-type'] = "Méthode: Webkit Compass (iOS)";
        } else if (e.absolute || e.alpha !== null) {
            heading = 360 - e.alpha; // Android
            db['compass-type'] = "Méthode: Absolute Alpha (Android)";
        }
        db['compass'] = Math.round(heading) + "°";
        
        // Si le magnétomètre standard a échoué, on déduit une activité magnétique
        if (!db['mag']) {
            db['mag'] = `A:${e.alpha?.toFixed(0)} B:${e.beta?.toFixed(0)} G:${e.gamma?.toFixed(0)}`;
        }
    };

    // 3. BOUCLE DE RENDU
    const render = () => {
        if (db['compass']) document.getElementById('v-compass').innerText = db['compass'];
        if (db['compass-type']) document.getElementById('v-compass-type').innerText = db['compass-type'];
        if (db['mag']) document.getElementById('v-mag').innerText = db['mag'];
        if (db['lux']) document.getElementById('v-lux').innerText = db['lux'];
        if (db['lux-src']) document.getElementById('v-lux-source').innerText = db['lux-src'];
        
        requestAnimationFrame(render);
    };

    document.getElementById('btn-start').onclick = async () => {
        document.getElementById('btn-start').style.display = 'none';
        
        // Demande de permissions (iOS)
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            await DeviceOrientationEvent.requestPermission();
        }

        initLight();
        initMagneto();
        
        // Accéléromètre standard en plus
        window.addEventListener('devicemotion', (e) => {
            const a = e.accelerationIncludingGravity;
            document.getElementById('v-acc').innerText = `${a.x?.toFixed(1)}, ${a.y?.toFixed(1)}, ${a.z?.toFixed(1)}`;
        });

        render();
    };
}
</script>
</body>
</html>
