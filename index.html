<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SENSORY BLACK BOX v8.0 - EXPERT</title>
    <style>
        :root {
            --bg: #050505;
            --card: #111111;
            --border: #222;
            --accent: #00ff9d;
            --text: #ffffff;
            --label: #888888;
            --warn: #ff9d00;
            --axis-x: #ff4444;
            --axis-y: #44ff44;
            --axis-z: #4444ff;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'SF Mono', 'Consolas', monospace;
            margin: 0;
            padding: 10px;
            padding-bottom: 90px;
            font-size: 10px;
            user-select: none;
        }

        h1 { color: var(--accent); text-align: left; font-size: 14px; margin: 0 0 15px 0; letter-spacing: 2px; }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        /* --- COMPASS MODULE (Full Width) --- */
        .compass-module {
            grid-column: span 2;
            background: var(--card);
            border: 1px solid var(--border);
            padding: 12px;
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            border-radius: 2px;
        }
        .compass-viz { width: 80px; height: 80px; position: relative; margin-right: 15px; }
        .compass-ring { 
            width: 100%; height: 100%; border: 1px solid #333; border-radius: 50%; 
            position: relative; transition: transform 0.1s linear;
        }
        .needle-n { position: absolute; top: 5px; left: 50%; transform: translateX(-50%); width: 2px; height: 35px; background: var(--axis-x); }
        .needle-s { position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); width: 2px; height: 35px; background: #fff; }

        /* --- CARDS & XYZ STACKING --- */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            position: relative;
            overflow: hidden;
        }
        .label { color: var(--label); font-size: 8px; text-transform: uppercase; letter-spacing: 1px; }
        
        .xyz-container { display: flex; flex-direction: column; gap: 2px; }
        .xyz-row { display: grid; grid-template-columns: 12px 1fr 1fr 1fr; align-items: center; gap: 4px; border-bottom: 1px solid #1a1a1a; padding-bottom: 2px; }
        .axis-label { font-weight: bold; font-size: 8px; }
        .val-cur { color: #fff; font-size: 11px; }
        .val-avg { color: var(--accent); font-size: 9px; opacity: 0.8; }
        .val-max { color: var(--warn); font-size: 9px; text-align: right; }

        .single-val { font-size: 18px; font-weight: bold; color: var(--accent); margin: 5px 0; }
        .sub-text { font-size: 9px; color: var(--label); }

        .bar-bg { width: 100%; height: 2px; background: #222; margin-top: 4px; }
        .bar-fill { height: 100%; background: var(--accent); width: 0%; }

        button#btn-init {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--accent); color: #000; border: none; padding: 15px 40px;
            font-weight: bold; font-size: 12px; border-radius: 2px; z-index: 1000;
            box-shadow: 0 10px 30px rgba(0,255,157,0.3);
        }

        .header-xyz { display: grid; grid-template-columns: 12px 1fr 1fr 1fr; font-size: 7px; color: var(--label); margin-bottom: 2px; }
        #calib-warn { color: var(--warn); font-size: 8px; animation: blink 1s infinite; display: none; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <h1>SENSORY BLACK BOX <span style="color:#555">v8.0</span></h1>

    <div class="compass-module">
        <div class="compass-viz">
            <div class="compass-ring" id="ui-ring">
                <div class="needle-n"></div><div class="needle-s"></div>
            </div>
        </div>
        <div>
            <div class="label">Heading</div>
            <div id="ui-heading" style="font-size: 28px; font-weight: bold;">---°</div>
            <div id="ui-cardinal" style="color: var(--accent); font-size: 12px;">---</div>
            <div id="calib-warn">CALIBRATION REQUIS (8-SHAPE)</div>
        </div>
    </div>

    <div class="dashboard" id="grid"></div>

    <button id="btn-init">INITIALIZE SENSORS</button>

    <video id="hidden-cam" autoplay playsinline muted style="display:none;"></video>
    <canvas id="lux-canvas" width="30" height="30" style="display:none;"></canvas>

<script>
{
    /**
     * DataEngine gère le stockage circulaire pour la moyenne (1s à ~60fps = 60 points)
     * et le tracking des valeurs maximales.
     */
    class DataEngine {
        constructor(bufferSize = 60) {
            this.bufferSize = bufferSize;
            this.reset();
        }
        reset() {
            this.data = {
                x: { cur: 0, buf: [], max: 0 },
                y: { cur: 0, buf: [], max: 0 },
                z: { cur: 0, buf: [], max: 0 },
                s: { cur: 0, buf: [], max: 0 }
            };
        }
        update(x, y = null, z = null) {
            if (y !== null && z !== null) {
                this._push('x', x); this._push('y', y); this._push('z', z);
            } else {
                this._push('s', x);
            }
        }
        _push(key, val) {
            const d = this.data[key];
            d.cur = val;
            d.buf.push(val);
            if (d.buf.length > this.bufferSize) d.buf.shift();
            if (Math.abs(val) > Math.abs(d.max)) d.max = val;
        }
        getStats(key) {
            const d = this.data[key];
            const avg = d.buf.reduce((a, b) => a + b, 0) / d.buf.length || 0;
            return { cur: d.cur, avg: avg, max: d.max };
        }
    }

    const metrics = [
        { id: 'accel', name: "Accéléromètre", unit: "m/s²", type: 'xyz' },
        { id: 'gyro', name: "Gyroscope", unit: "rad/s", type: 'xyz' },
        { id: 'mag', name: "Magnétomètre", unit: "µT", type: 'xyz' },
        { id: 'gravity', name: "Gravité", unit: "m/s²", type: 'xyz' },
        { id: 'lux', name: "Luminosité (Est.)", unit: "Lux", type: 'single', bar: true },
        { id: 'prox', name: "Proximité", unit: "", type: 'single' },
        { id: 'baro', name: "Pression", unit: "hPa", type: 'single' },
        { id: 'temp', name: "Température", unit: "°C", type: 'single' },
        { id: 'gps', name: "GPS Position", unit: "", type: 'text' },
        { id: 'gps_alt', name: "Altitude (MSL)", unit: "m", type: 'single' },
        { id: 'net', name: "Network Latency", unit: "ms", type: 'single' },
        { id: 'memory', name: "JS Heap Use", unit: "MB", type: 'single', bar: true }
    ];

    const engines = {};
    const fmt = (v) => v.toFixed(2);

    // Initialisation du DOM
    const grid = document.getElementById('grid');
    metrics.forEach(m => {
        engines[m.id] = new DataEngine();
        const card = document.createElement('div');
        card.className = 'card';
        card.onclick = () => engines[m.id].reset();
        
        let content = `<div class="label">${m.name}</div>`;
        
        if (m.type === 'xyz') {
            content += `
                <div class="header-xyz"><div></div><div>CUR</div><div>AVG(1s)</div><div>MAX</div></div>
                <div class="xyz-container">
                    ${['x', 'y', 'z'].map(axis => `
                        <div class="xyz-row">
                            <div class="axis-label" style="color:var(--axis-${axis})">${axis.toUpperCase()}</div>
                            <div class="val-cur" id="${m.id}-${axis}-cur">0.00</div>
                            <div class="val-avg" id="${m.id}-${axis}-avg">0.00</div>
                            <div class="val-max" id="${m.id}-${axis}-max">0.00</div>
                        </div>
                    `).join('')}
                </div>`;
        } else if (m.type === 'single') {
            content += `
                <div class="single-val" id="${m.id}-s-cur">--</div>
                <div class="sub-text">AVG: <span id="${m.id}-s-avg">--</span> | MAX: <span id="${m.id}-s-max">--</span> ${m.unit}</div>
                ${m.bar ? `<div class="bar-bg"><div class="bar-fill" id="${m.id}-bar"></div></div>` : ''}`;
        } else {
            content += `<div class="val-cur" id="${m.id}-text" style="font-size:9px; margin-top:5px;">Awaiting signal...</div>`;
        }
        
        card.innerHTML = content;
        grid.appendChild(card);
    });

    const updateUI = () => {
        metrics.forEach(m => {
            const eng = engines[m.id];
            if (m.type === 'xyz') {
                ['x', 'y', 'z'].forEach(axis => {
                    const stats = eng.getStats(axis);
                    document.getElementById(`${m.id}-${axis}-cur`).innerText = fmt(stats.cur);
                    document.getElementById(`${m.id}-${axis}-avg`).innerText = fmt(stats.avg);
                    document.getElementById(`${m.id}-${axis}-max`).innerText = fmt(stats.max);
                });
            } else if (m.type === 'single') {
                const stats = eng.getStats('s');
                document.getElementById(`${m.id}-s-cur`).innerText = Math.round(stats.cur);
                document.getElementById(`${m.id}-s-avg`).innerText = fmt(stats.avg);
                document.getElementById(`${m.id}-s-max`).innerText = fmt(stats.max);
                if (m.bar) {
                    const bar = document.getElementById(`${m.id}-bar`);
                    let p = (stats.cur / (m.id === 'lux' ? 255 : 100)) * 100;
                    bar.style.width = Math.min(p, 100) + "%";
                }
            }
        });
        requestAnimationFrame(updateUI);
    };

    const startSensors = async () => {
        // Mouvement et Rotation
        window.addEventListener('devicemotion', (e) => {
            const acc = e.accelerationIncludingGravity || {x:0, y:0, z:0};
            engines.accel.update(acc.x, acc.y, acc.z);
            
            const rot = e.rotationRate || {alpha:0, beta:0, gamma:0};
            engines.gyro.update(rot.alpha, rot.beta, rot.gamma);
        });

        // Orientation & Boussole
        window.addEventListener('deviceorientation', (e) => {
            let heading = e.webkitCompassHeading || (360 - e.alpha);
            document.getElementById('ui-ring').style.transform = `rotate(${-heading}deg)`;
            document.getElementById('ui-heading').innerText = Math.round(heading) + "°";
            document.getElementById('ui-cardinal').innerText = ["N", "NE", "E", "SE", "S", "SO", "O", "NO"][Math.round(heading / 45) % 8];
            
            // Simulation gravité via angles
            const gx = Math.sin(e.gamma * Math.PI/180) * 9.81;
            const gy = Math.sin(e.beta * Math.PI/180) * 9.81;
            engines.gravity.update(gx, gy, 9.81 - Math.abs(gx+gy)/2);
        });

        // GPS
        navigator.geolocation.watchPosition(p => {
            const c = p.coords;
            document.getElementById('gps-text').innerText = `${c.latitude.toFixed(5)}°N\n${c.longitude.toFixed(5)}°E\n±${c.accuracy.toFixed(0)}m`;
            engines.gps_alt.update(c.altitude || 0);
        }, null, {enableHighAccuracy: true});

        // Magnétomètre (si API disponible)
        if ('Magnetometer' in window) {
            try {
                const mag = new Magnetometer({frequency: 10});
                mag.onreading = () => {
                    engines.mag.update(mag.x, mag.y, mag.z);
                    const total = Math.sqrt(mag.x**2 + mag.y**2 + mag.z**2);
                    document.getElementById('calib-warn').style.display = (total > 100 || total < 20) ? 'block' : 'none';
                };
                mag.start();
            } catch(e) {}
        }

        // Memory & Network
        setInterval(() => {
            if (performance.memory) {
                engines.memory.update(performance.memory.usedJSHeapSize / 1048576);
            }
            const start = Date.now();
            fetch('favicon.ico', { mode: 'no-cors' }).then(() => {
                engines.net.update(Date.now() - start);
            }).catch(() => {});
        }, 3000);

        // Luminosité via Caméra
        initCameraLux();
        updateUI();
    };

    const initCameraLux = async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({video: {facingMode:'environment'}});
            const v = document.getElementById('hidden-cam');
            v.srcObject = stream;
            const ctx = document.getElementById('lux-canvas').getContext('2d');
            setInterval(() => {
                if(v.readyState === 4) {
                    ctx.drawImage(v, 0, 0, 30, 30);
                    const d = ctx.getImageData(0,0,30,30).data;
                    let lum = 0;
                    for(let i=0; i<d.length; i+=4) lum += (d[i] + d[i+1] + d[i+2]) / 3;
                    engines.lux.update(lum / (d.length/4));
                }
            }, 500);
        } catch(e) {}
    };

    document.getElementById('btn-init').onclick = async () => {
        document.getElementById('btn-init').style.display = 'none';
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            await DeviceOrientationEvent.requestPermission();
            await DeviceMotionEvent.requestPermission();
        }
        startSensors();
    };
}
</script>
</body>
</html>
