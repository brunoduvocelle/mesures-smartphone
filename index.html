<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FULL SENSOR BLACK BOX - XYZ ADVANCED</title>
    <style>
        :root {
            --bg: #050505;
            --card: #101010;
            --border: #333;
            --accent: #00ff9d;
            --text: #cccccc;
            --label: #666666;
            --warn: #ff9d00;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Consolas', 'Monaco', monospace;
            margin: 0;
            padding: 10px;
            padding-bottom: 80px;
            font-size: 10px;
        }

        h1 { color: var(--accent); text-align: center; font-size: 14px; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin: 5px 0; text-transform: uppercase; }
        
        button#btn-init {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--accent); color: #000;
            border: none; padding: 15px 30px;
            font-weight: bold; font-size: 14px;
            border-radius: 4px; cursor: pointer;
            box-shadow: 0 0 20px rgba(0, 255, 157, 0.2);
            z-index: 1000;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 8px;
            margin-top: 15px;
        }

        /* COMPASS */
        .compass-module {
            grid-column: 1 / -1;
            background: #111;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: space-around;
        }
        .compass-viz { width: 80px; height: 80px; position: relative; }
        .compass-ring { width: 100%; height: 100%; border: 2px solid #333; border-radius: 50%; position: relative; }
        .needle-n { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 3px; height: 12px; background: #ff4444; }
        .phone-marker { position: absolute; top: -8px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-bottom: 8px solid var(--accent); z-index: 10; }

        /* CARDS */
        .card { background: var(--card); border: 1px solid var(--border); padding: 8px; border-radius: 3px; position: relative; }
        .card.active { border-color: var(--accent); }
        .label { color: var(--accent); font-size: 9px; font-weight: bold; margin-bottom: 6px; border-bottom: 1px solid #222; }
        
        .data-grid { display: grid; grid-template-columns: 15px 1fr 1fr 1fr; gap: 2px; align-items: center; }
        .col-h { color: var(--label); font-size: 7px; text-align: center; }
        .row-l { color: var(--label); font-weight: bold; font-size: 9px; }
        .val-cur { color: #fff; text-align: right; }
        .val-avg { color: #888; text-align: right; }
        .val-max { color: var(--warn); text-align: right; }

        .bar-container { height: 2px; background: #222; margin-top: 8px; width: 100%; }
        .bar-fill { height: 100%; background: var(--accent); width: 0%; }

        #hidden-cam { display: none; }
    </style>
</head>
<body>

    <h1>ARCHITECTE SENSOR CORE v3.0</h1>

    <div class="compass-module">
        <div class="compass-viz">
            <div class="phone-marker"></div>
            <div class="compass-ring" id="ui-ring">
                <div class="needle-n"></div>
            </div>
        </div>
        <div style="text-align:right">
            <div class="label" style="border:none">CAP MAGNÉTIQUE</div>
            <div id="ui-heading" style="font-size:22px; font-weight:bold; color:#fff">---°</div>
            <div id="ui-cardinal" style="color:var(--accent)">---</div>
            <div id="ui-tilt" style="color:var(--warn); font-size:9px">Tilt: --°</div>
        </div>
    </div>

    <div class="dashboard" id="grid"></div>

    <button id="btn-init">INITIALISER LES CAPTEURS</button>
    <video id="hidden-cam" autoplay playsinline muted></video>
    <canvas id="lux-canvas" width="30" height="30" style="display:none;"></canvas>

<script>
{
    // --- LOGIQUE DE TRAITEMENT XYZ ---
    class MultiAxisProcessor {
        constructor(size = 20) {
            this.size = size;
            this.data = {
                x: { cur: 0, buffer: [], max: 0 },
                y: { cur: 0, buffer: [], max: 0 },
                z: { cur: 0, buffer: [], max: 0 }
            };
        }

        update(x, y, z) {
            ['x', 'y', 'z'].forEach((axis, i) => {
                const val = [x, y, z][i] || 0;
                const d = this.data[axis];
                d.cur = val;
                d.buffer.push(val);
                if(d.buffer.length > this.size) d.buffer.shift();
                if(Math.abs(val) > Math.abs(d.max)) d.max = val;
            });
        }

        getAvg(axis) {
            const b = this.data[axis].buffer;
            return b.reduce((a, b) => a + b, 0) / b.length || 0;
        }
    }

    const metrics = [
        { id: 'acc', name: "ACCÉLÉRATION (m/s²)", axes: true },
        { id: 'gyro', name: "GYROSCOPE (rad/s)", axes: true },
        { id: 'mag', name: "MAGNÉTOMÈTRE (µT)", axes: true },
        { id: 'gps', name: "GPS (Vitesse/Alt/Prec)", axes: false },
        { id: 'sys', name: "SYSTÈME (Bat/Net/Lux)", axes: false }
    ];

    const procs = {
        acc: new MultiAxisProcessor(),
        gyro: new MultiAxisProcessor(),
        mag: new MultiAxisProcessor()
    };

    // --- UI GEN ---
    const grid = document.getElementById('grid');
    const refs = {};

    metrics.forEach(m => {
        const card = document.createElement('div');
        card.className = 'card';
        let html = `<div class="label">${m.name}</div>`;
        
        if(m.axes) {
            html += `
                <div class="data-grid">
                    <div></div><div class="col-h">INST</div><div class="col-h">LISSÉ</div><div class="col-h">MAX</div>
                    <div class="row-l">X</div><div class="val-cur" id="${m.id}-x-c">0</div><div class="val-avg" id="${m.id}-x-a">0</div><div class="val-max" id="${m.id}-x-m">0</div>
                    <div class="row-l">Y</div><div class="val-cur" id="${m.id}-y-c">0</div><div class="val-avg" id="${m.id}-y-a">0</div><div class="val-max" id="${m.id}-y-m">0</div>
                    <div class="row-l">Z</div><div class="val-cur" id="${m.id}-z-c">0</div><div class="val-avg" id="${m.id}-z-a">0</div><div class="val-max" id="${m.id}-z-m">0</div>
                </div>`;
        } else {
            html += `<div id="${m.id}-content" style="white-space:pre; line-height:1.4">Attente...</div>`;
        }
        card.innerHTML = html;
        grid.appendChild(card);
        refs[m.id] = card;
    });

    const refreshXYZ = (id) => {
        const p = procs[id];
        ['x', 'y', 'z'].forEach(axis => {
            document.getElementById(`${id}-${axis}-c`).innerText = p.data[axis].cur.toFixed(2);
            document.getElementById(`${id}-${axis}-a`).innerText = p.getAvg(axis).toFixed(2);
            document.getElementById(`${id}-${axis}-m`).innerText = p.data[axis].max.toFixed(2);
        });
        refs[id].classList.add('active');
    };

    // --- ENGINE ---
    const start = async () => {
        // Accéléromètre & Gyro
        window.addEventListener('devicemotion', (e) => {
            const a = e.acceleration || {x:0, y:0, z:0};
            procs.acc.update(a.x, a.y, a.z);
            refreshXYZ('acc');

            const r = e.rotationRate || {alpha:0, beta:0, gamma:0};
            procs.gyro.update(r.alpha, r.beta, r.gamma);
            refreshXYZ('gyro');
        });

        // Magnétomètre
        if ('Magnetometer' in window) {
            try {
                const mag = new Magnetometer({frequency: 10});
                mag.onreading = () => {
                    procs.mag.update(mag.x, mag.y, mag.z);
                    refreshXYZ('mag');
                };
                mag.start();
            } catch(e) {}
        }

        // Boussole (Lissage Spécial)
        let sHead = 0;
        window.addEventListener('deviceorientation', (e) => {
            let h = e.webkitCompassHeading || (360 - e.alpha) || 0;
            let diff = h - sHead;
            if(diff > 180) diff -= 360; if(diff < -180) diff += 360;
            sHead += diff * 0.08;
            const finalH = (sHead + 360) % 360;
            
            document.getElementById('ui-ring').style.transform = `rotate(${-finalH}deg)`;
            document.getElementById('ui-heading').innerText = Math.round(finalH) + "°";
            document.getElementById('ui-cardinal').innerText = ["NORD", "N-EST", "EST", "S-EST", "SUD", "S-OUEST", "OUEST", "N-OUEST"][Math.round(finalH / 45) % 8];
            document.getElementById('ui-tilt').innerText = `Tilt: ${Math.max(Math.abs(e.beta||0), Math.abs(e.gamma||0)).toFixed(1)}°`;
        });

        // GPS
        navigator.geolocation.watchPosition(p => {
            const c = p.coords;
            document.getElementById('gps-content').innerText = 
                `VIT: ${(c.speed*3.6||0).toFixed(1)} km/h\nALT: ${c.altitude?.toFixed(0)||'--'} m\nACC: ±${c.accuracy.toFixed(0)} m`;
            refs.gps.classList.add('active');
        }, null, {enableHighAccuracy: true});

        // Système
        setInterval(async () => {
            const bat = navigator.getBattery ? await navigator.getBattery() : {level:0, charging:false};
            const conn = navigator.connection || {};
            const net = conn.effectiveType || conn.type || "N/A";
            document.getElementById('sys-content').innerText = 
                `BAT: ${(bat.level*100).toFixed(0)}% (${bat.charging?'Charge':'USB'})\nNET: ${net.toUpperCase()} (${conn.downlink||0}Mb)\nLUX: ${window.lastLux || '--'}`;
            refs.sys.classList.add('active');
        }, 1000);

        initLux();
    };

    const initLux = async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({video: {facingMode:'environment'}});
            const v = document.getElementById('hidden-cam'); v.srcObject = stream;
            const ctx = document.getElementById('lux-canvas').getContext('2d');
            setInterval(() => {
                if(v.readyState === 4) {
                    ctx.drawImage(v, 0, 0, 30, 30);
                    const d = ctx.getImageData(0,0,30,30).data;
                    let l = 0; for(let i=0; i<d.length; i+=4) l += (d[i]+d[i+1]+d[i+2])/3;
                    window.lastLux = Math.round(l/(d.length/4));
                }
            }, 1000);
        } catch(e) {}
    };

    document.getElementById('btn-init').onclick = async () => {
        document.getElementById('btn-init').style.display = 'none';
        if(typeof DeviceOrientationEvent?.requestPermission === 'function') {
            await DeviceOrientationEvent.requestPermission();
            await DeviceMotionEvent.requestPermission();
        }
        start();
    };
}
</script>
</body>
</html>
