<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PRECISION SENSOR SUITE</title>
    <style>
        :root {
            --bg: #050505;
            --card: #141b2d;
            --accent: #00d2ff;
            --text: #e0e0e0;
            --dim: #5c6b7f;
            --warn: #ffca28;
            --success: #00e676;
            --danger: #ff5252;
            --north: #ff3d00;
        }
        body {
            background: var(--bg); color: var(--text);
            font-family: 'Consolas', 'Monaco', monospace;
            margin: 0; padding: 15px;
            font-size: 12px;
            padding-bottom: 60px;
            overscroll-behavior: none;
        }
        h1 { 
            color: var(--accent); text-align: center; 
            border-bottom: 1px solid #333; padding-bottom: 10px; 
            font-weight: 400; letter-spacing: 1px; margin-top: 0;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        /* --- ZONE BOUSSOLE AVANCÉE --- */
        .instrument.boussole-container {
            grid-column: 1 / -1;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            padding: 15px 25px;
            background: radial-gradient(circle at 50% 50%, #1f2a40 0%, #141b2d 100%);
            border: 1px solid #333;
            min-height: 160px;
        }

        .compass-wrapper {
            position: relative;
            width: 140px; height: 140px;
        }

        .compass-rose {
            width: 100%; height: 100%;
            transition: transform 0.1s linear; /* Lissage JS préféré, mais CSS backup */
        }

        /* Le niveau à bulle (Spirit Level) */
        .bubble-level-bg {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 40px; height: 40px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            z-index: 10;
            pointer-events: none;
        }
        .bubble-dot {
            position: absolute;
            top: 50%; left: 50%;
            width: 12px; height: 12px;
            background-color: var(--success);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 5px var(--success);
            transition: transform 0.1s ease-out; /* Réactif mais fluide */
            z-index: 11;
        }

        .compass-data {
            text-align: right;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .large-val { font-size: 28px; font-weight: bold; color: var(--text); }
        .sub-val { font-size: 11px; color: var(--dim); }
        .calib-status { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #333; display: inline-block; margin-top: 5px;}
        .calib-ok { color: var(--success); border: 1px solid var(--success); }
        .calib-bad { color: var(--warn); border: 1px solid var(--warn); animation: pulse 2s infinite; }

        /* --- CARTES INSTRUMENTS --- */
        .instrument {
            background: var(--card);
            border: 1px solid #2d3748;
            padding: 12px;
            border-radius: 6px;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .instrument.active { border-left: 3px solid var(--success); }
        .instrument.inactive { border-left: 3px solid #333; opacity: 0.7; }

        .label { color: var(--accent); font-weight: 700; font-size: 9px; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
        .value { font-size: 13px; font-weight: 600; color: #fff; font-family: 'Segoe UI', sans-serif; }
        .unit { font-size: 9px; color: var(--dim); margin-left: 2px; }
        .meta { font-size: 9px; color: #666; margin-top: 4px; border-top: 1px solid #222; padding-top: 4px; }

        #btn-start {
            position: sticky; top: 10px; z-index: 100;
            background: var(--accent); color: #000;
            border: none; padding: 14px; width: 100%;
            font-weight: 800; font-size: 14px;
            border-radius: 4px; cursor: pointer;
            text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(0, 210, 255, 0.2);
            transition: all 0.2s;
        }
        #btn-start:active { transform: scale(0.98); }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        #hidden-video { display: none; }
    </style>
</head>
<body>

    <h1>LABORATOIRE DE CAPTEURS</h1>
    <button id="btn-start">DÉVERROUILLER L'ACCÈS MATÉRIEL</button>
    <div id="status-log" style="color: var(--dim); text-align: center; margin: 8px 0; font-size: 10px;">En attente d'interaction utilisateur...</div>

    <div class="dashboard" id="grid">
        
        <div class="instrument boussole-container active">
            <div class="compass-wrapper">
                <div style="position: absolute; top: -5px; left: 50%; transform: translateX(-50%); width: 2px; height: 10px; background: var(--accent); z-index: 20;"></div>
                
                <div class="compass-rose" id="viz-compass">
                    <svg viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="48" fill="none" stroke="#333" stroke-width="1"/>
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#444" stroke-width="0.5" stroke-dasharray="1 2"/>
                        
                        <path d="M50 2 L50 6" stroke="var(--north)" stroke-width="2"/>
                        <path d="M50 94 L50 98" stroke="#fff" stroke-width="1"/>
                        <path d="M94 50 L98 50" stroke="#fff" stroke-width="1"/>
                        <path d="M2 50 L6 50" stroke="#fff" stroke-width="1"/>
                        
                        <text x="50" y="18" fill="var(--north)" font-weight="bold" font-size="10" text-anchor="middle">N</text>
                        <text x="85" y="53" fill="#888" font-size="8" text-anchor="middle">E</text>
                        <text x="50" y="88" fill="#888" font-size="8" text-anchor="middle">S</text>
                        <text x="15" y="53" fill="#888" font-size="8" text-anchor="middle">O</text>
                    </svg>
                </div>

                <div class="bubble-level-bg"></div>
                <div class="bubble-dot" id="viz-bubble"></div>
            </div>

            <div class="compass-data">
                <div class="label">CAP MAGNÉTIQUE</div>
                <div class="large-val" id="val-compass">---°</div>
                <div class="sub-val" id="val-cardinal">---</div>
                <div class="sub-val" id="val-tilt">Inclin: 0°</div>
                <div class="calib-status calib-bad" id="calib-msg">NON CALIBRÉ</div>
            </div>
        </div>

        </div>

    <video id="hidden-video" autoplay playsinline muted></video>
    <canvas id="lux-canvas" width="30" height="30" style="display:none;"></canvas>

<script>
{
    // --- CONFIGURATION ---
    const ui = {
        compass: document.getElementById('viz-compass'),
        bubble: document.getElementById('viz-bubble'),
        valCompass: document.getElementById('val-compass'),
        valCardinal: document.getElementById('val-cardinal'),
        valTilt: document.getElementById('val-tilt'),
        calibMsg: document.getElementById('calib-msg'),
        log: document.getElementById('status-log'),
        grid: document.getElementById('grid')
    };

    const instruments = [
        { id: 'acc_g', name: "Force Totale (G)", unit: "G", def: "1.00", desc: "Doit être 1.00 au repos" },
        { id: 'acc_raw', name: "Accélération X/Y/Z", unit: "m/s²", def: "0 | 0 | 0", desc: "Mouvements bruts" },
        { id: 'gyro', name: "Rotation (Gyro)", unit: "rad/s", def: "0 | 0 | 0", desc: "Vitesse angulaire" },
        { id: 'mag_field', name: "Champ Magnétique", unit: "µT", def: "0", desc: "Force interférence" },
        { id: 'lux', name: "Luminosité", unit: "Lux", def: "--", desc: "Capteur ou Caméra" },
        { id: 'gps', name: "Position GPS", unit: "", def: "Recherche...", desc: "Lat / Lon" },
        { id: 'alt', name: "Altitude (GPS)", unit: "m", def: "--", desc: "Approx. WGS84" },
        { id: 'gps_acc', name: "Précision GPS", unit: "m", def: "--", desc: "Rayon de confiance" },
        { id: 'baro', name: "Pression Atmos.", unit: "hPa", def: "N/A", desc: "Baromètre physique" },
        { id: 'bat', name: "Batterie", unit: "%", def: "--", desc: "Niveau de charge" },
        { id: 'net', name: "Latence Réseau", unit: "ms", def: "--", desc: "RTT estimé" }
    ];

    const refs = {}; // Stockage des références DOM pour perf

    // --- INITIALISATION UI ---
    instruments.forEach(inst => {
        const div = document.createElement('div');
        div.className = 'instrument inactive';
        div.id = `card-${inst.id}`;
        div.innerHTML = `
            <div class="label">${inst.name}</div>
            <div class="value" id="v-${inst.id}">${inst.def}<span class="unit">${inst.unit}</span></div>
            <div class="meta">${inst.desc}</div>
        `;
        ui.grid.appendChild(div);
        refs[inst.id] = document.getElementById(`v-${inst.id}`);
        refs[`box-${inst.id}`] = div;
    });

    // --- LOGIQUE BOUSSOLE & NIVELLEMENT ---
    let heading = 0;
    let smoothHeading = 0;
    let tiltLR = 0; // Gamma
    let tiltFB = 0; // Beta

    const updateCompass = (alpha, beta, gamma, accuracy) => {
        // 1. Gestion du Cap (Heading) avec lissage
        let target = alpha;
        // Correction du passage 359->0
        let delta = target - smoothHeading;
        if (delta > 180) delta -= 360;
        if (delta < -180) delta += 360;
        smoothHeading += delta * 0.1; // Facteur lissage (0.1 = fluide)
        
        ui.compass.style.transform = `rotate(${-smoothHeading}deg)`;
        ui.valCompass.innerText = Math.round(smoothHeading < 0 ? smoothHeading + 360 : smoothHeading) + "°";
        ui.valCardinal.innerText = getCardinal(smoothHeading);

        // 2. Gestion du Niveau à Bulle (Spirit Level)
        // Limite visuelle à 20 degrés pour garder la bulle dans le cercle
        const maxTilt = 20; 
        const bX = Math.max(-maxTilt, Math.min(maxTilt, gamma || 0)); // Gauche/Droite
        const bY = Math.max(-maxTilt, Math.min(maxTilt, beta || 0));  // Avant/Arrière
        
        // Tilt total pour l'affichage numérique
        const totalTilt = Math.sqrt(beta*beta + gamma*gamma).toFixed(1);
        ui.valTilt.innerText = `Inclin: ${totalTilt}°`;
        ui.valTilt.style.color = totalTilt < 5 ? 'var(--success)' : 'var(--warn)';

        // Déplacement de la bulle (inversé pour simuler une bulle d'air)
        ui.bubble.style.transform = `translate(calc(-50% + ${bX}px), calc(-50% + ${bY}px))`;

        // 3. Status Calibration
        if (accuracy && accuracy > 15) { // Valeur arbitraire, dépend de l'API
             setCalib(true);
        } else if (totalTilt > 10) {
             setCalib(false, "METTRE À PLAT");
        } else {
             setCalib(true, "OK");
        }
    };

    const getCardinal = (h) => {
        h = h < 0 ? h + 360 : h;
        const dirs = ["N","NE","E","SE","S","SO","O","NO"];
        return dirs[Math.round(h/45) % 8];
    };

    const setCalib = (isOk, text) => {
        ui.calibMsg.className = isOk ? "calib-status calib-ok" : "calib-status calib-bad";
        ui.calibMsg.innerText = text || (isOk ? "CALIBRÉ" : "CALIBRAGE REQUIS");
    };

    // --- MOTEUR DE CAPTEURS ---
    const startSensors = async () => {
        // 1. DeviceOrientation (Boussole + Niveau)
        const handleOrient = (e) => {
            let h = 0;
            // Priorité: WebkitCompass (iOS) > Absolute (Android) > Alpha
            if (e.webkitCompassHeading) h = e.webkitCompassHeading;
            else if (e.alpha && e.absolute) h = 360 - e.alpha;
            else if (e.alpha) h = e.alpha; // Fallback relatif

            updateCompass(h, e.beta, e.gamma, e.webkitCompassAccuracy);
        };
        
        // Double écoute pour compatibilité max
        window.addEventListener('deviceorientationabsolute', handleOrient, true);
        window.addEventListener('deviceorientation', handleOrient, true);

        // 2. DeviceMotion (Accéléromètre avancé)
        window.addEventListener('devicemotion', (e) => {
            const a = e.accelerationIncludingGravity || {x:0, y:0, z:0};
            const r = e.rotationRate || {alpha:0, beta:0, gamma:0};

            // Calcul G-Force Totale
            const gTotal = Math.sqrt(a.x*a.x + a.y*a.y + a.z*a.z) / 9.81;
            updateDisplay('acc_g', gTotal.toFixed(3));
            refs['box-acc_g'].className = "instrument active";
            // Couleur dynamique si choc détecté (> 2G)
            refs['v-acc_g'].style.color = gTotal > 1.5 ? 'var(--danger)' : '#fff';

            updateDisplay('acc_raw', `${f(a.x)} | ${f(a.y)} | ${f(a.z)}`);
            updateDisplay('gyro', `${f(r.alpha)} | ${f(r.beta)} | ${f(r.gamma)}`);
            refs['box-acc_raw'].className = "instrument active";
        });

        // 3. Magnétomètre Brut (Si dispo pour interférences)
        if ('Magnetometer' in window) {
            try {
                const mag = new Magnetometer({frequency: 10});
                mag.onreading = () => {
                    // Force totale du champ (µT)
                    const totalField = Math.sqrt(mag.x**2 + mag.y**2 + mag.z**2);
                    updateDisplay('mag_field', totalField.toFixed(1));
                    refs['box-mag_field'].className = "instrument active";
                    // Alerte interférence magnétique domestique (> 60µT environ)
                    if (totalField > 60) setCalib(false, "INTERFÉRENCE MAG.");
                };
                mag.start();
            } catch(e){}
        }

        // 4. GPS & Baromètre
        if ('geolocation' in navigator) {
            navigator.geolocation.watchPosition(p => {
                updateDisplay('gps', `${p.coords.latitude.toFixed(5)} / ${p.coords.longitude.toFixed(5)}`);
                if(p.coords.altitude) updateDisplay('alt', p.coords.altitude.toFixed(1));
                updateDisplay('gps_acc', `±${p.coords.accuracy.toFixed(0)}`);
                refs['box-gps'].className = "instrument active";
            }, null, {enableHighAccuracy:true});
        }

        if ('PressureSensor' in window) {
            try {
                const baro = new PressureSensor({frequency: 1});
                baro.onreading = () => {
                    updateDisplay('baro', baro.pressure.toFixed(1));
                    refs['box-baro'].className = "instrument active";
                };
                baro.start();
            } catch(e){}
        }

        // 5. Batterie & Réseau
        if (navigator.getBattery) {
            navigator.getBattery().then(b => {
                const up = () => {
                   updateDisplay('bat', `${(b.level*100).toFixed(0)}% ${b.charging?'⚡':''}`);
                   refs['box-bat'].className = "instrument active";
                };
                b.onlevelchange = up; b.onchargingchange = up; up();
            });
        }
        if (navigator.connection) {
            updateDisplay('net', navigator.connection.rtt || "?");
            refs['box-net'].className = "instrument active";
        }

        // 6. Lumière (Fallback)
        initLight();
    };

    const updateDisplay = (id, val) => {
        if (refs[id]) refs[id].innerHTML = val + `<span class="unit">${instruments.find(i=>i.id===id).unit}</span>`;
    };

    const f = (n) => (n||0).toFixed(1);

    const initLight = async () => {
        if ('AmbientLightSensor' in window) {
            const als = new AmbientLightSensor();
            als.onreading = () => {
                updateDisplay('lux', als.illuminance.toFixed(0));
                refs['box-lux'].className = "instrument active";
            };
            als.start();
        } else {
            // Fallback caméra (simplifié pour perf)
            try {
                const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
                const vid = document.getElementById('hidden-video');
                const cvs = document.getElementById('lux-canvas');
                const ctx = cvs.getContext('2d', {willReadFrequently:true});
                vid.srcObject = stream;
                
                const loopLux = () => {
                    if (vid.readyState === 4) {
                        ctx.drawImage(vid,0,0,30,30);
                        const d = ctx.getImageData(0,0,30,30).data;
                        let l = 0;
                        for(let i=0; i<d.length; i+=4) l += (d[i]+d[i+1]+d[i+2])/3;
                        updateDisplay('lux', Math.round(l/(d.length/4)*2) + " (Cam)");
                        refs['box-lux'].className = "instrument active";
                    }
                    setTimeout(loopLux, 500); // 2Hz suffisant
                };
                loopLux();
            } catch(e) { updateDisplay('lux', "N/A"); }
        }
    };

    // --- BOUTON START ---
    document.getElementById('btn-start').onclick = async () => {
        const btn = document.getElementById('btn-start');
        btn.style.display = 'none';
        
        // Permission iOS
        if (typeof DeviceOrientationEvent?.requestPermission === 'function') {
            ui.log.innerText = "Demande permission iOS...";
            try { await DeviceOrientationEvent.requestPermission(); } catch(e){}
        }
        
        startSensors();
        ui.log.innerText = "Système de mesure actif. Gardez l'appareil à plat.";
    };
}
</script>
</body>
</html>
