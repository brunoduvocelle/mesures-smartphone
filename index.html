<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FULL SENSOR BLACK BOX - OPTIMIZED</title>
    <style>
        :root {
            --bg: #050505;
            --card: #101010;
            --border: #333;
            --accent: #00ff9d;
            --text: #cccccc;
            --label: #666666;
            --warn: #ff9d00;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Consolas', 'Monaco', monospace;
            margin: 0;
            padding: 10px;
            padding-bottom: 80px;
            font-size: 11px;
        }

        h1 { color: var(--accent); text-align: center; font-size: 16px; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-top: 5px; text-transform: uppercase; }
        
        button#btn-init {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--accent); color: #000;
            border: none; padding: 15px 30px;
            font-weight: bold; font-size: 14px;
            border-radius: 4px; cursor: pointer;
            box-shadow: 0 0 20px rgba(0, 255, 157, 0.2);
            z-index: 1000;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 6px;
            margin-top: 15px;
        }

        .compass-module {
            grid-column: 1 / -1;
            background: #111;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .compass-viz { width: 100px; height: 100px; position: relative; }
        .compass-ring { width: 100%; height: 100%; border: 2px solid #333; border-radius: 50%; position: relative; transition: transform 0.1s linear; }
        .needle-n { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 4px; height: 15px; background: #ff4444; }
        .needle-s { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 4px; height: 15px; background: #eee; }
        .phone-marker { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 10px solid var(--accent); z-index: 10; }

        .compass-stats { text-align: right; width: 60%; }
        .big-val { font-size: 24px; color: #fff; font-weight: bold; }

        .card { background: var(--card); border: 1px solid var(--border); padding: 8px; border-radius: 3px; display: flex; flex-direction: column; justify-content: space-between; min-height: 80px; }
        .card.active { border-color: var(--accent); }
        .label { color: var(--label); font-size: 9px; text-transform: uppercase; font-weight: bold; margin-bottom: 4px; }
        .val { color: var(--text); font-size: 11px; white-space: pre-wrap; word-break: break-all; }
        .val-peak { color: var(--warn); font-size: 9px; margin-bottom: 2px; }
        .unit { color: #555; font-size: 9px; }
        
        .bar-container { height: 3px; background: #222; margin-top: 5px; width: 100%; }
        .bar-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.1s; }

        #hidden-cam { display: none; }
    </style>
</head>
<body>

    <h1>BLACK BOX SENSOR v2.0</h1>

    <div class="compass-module">
        <div class="compass-viz">
            <div class="phone-marker"></div>
            <div class="compass-ring" id="ui-ring">
                <div class="needle-n"></div><div class="needle-s"></div>
            </div>
        </div>
        <div class="compass-stats">
            <div class="label">Cap (Lissé 30 pts)</div>
            <div class="big-val" id="ui-heading">---°</div>
            <div class="val" id="ui-cardinal">---</div>
            <div class="val" id="ui-tilt" style="margin-top:5px; color:var(--warn);">Tilt: 0°</div>
        </div>
    </div>

    <div class="dashboard" id="grid"></div>

    <button id="btn-init">DÉMARRER L'ACQUISITION</button>
    <video id="hidden-cam" autoplay playsinline muted></video>
    <canvas id="lux-canvas" width="30" height="30" style="display:none;"></canvas>

<script>
{
    // --- GESTION DES DONNÉES (LISSAGE + MAX) ---
    class SensorProcessor {
        constructor(size = 30) {
            this.size = size;
            this.buffer = [];
            this.peak = 0;
        }
        add(val) {
            const v = parseFloat(val);
            if(isNaN(v)) return;
            this.buffer.push(v);
            if(this.buffer.length > this.size) this.buffer.shift();
            if(Math.abs(v) > Math.abs(this.peak)) this.peak = v;
        }
        get avg() {
            return this.buffer.reduce((a, b) => a + b, 0) / this.buffer.length || 0;
        }
    }

    const metrics = [
        { id: 'acc_lin', name: "Accél. Linéaire", unit: "m/s²", def: "0.00" },
        { id: 'g_force', name: "Force G", unit: "G", def: "1.00", bar: true },
        { id: 'gyro', name: "Gyroscope", unit: "rad/s", def: "0.00" },
        { id: 'mag_raw', name: "Magnétomètre Brut", unit: "µT", def: "--" },
        { id: 'mag_total', name: "Champ Mag. Total", unit: "µT", def: "0", bar: true },
        { id: 'gps_spd', name: "Vitesse GPS", unit: "km/h", def: "0" },
        { id: 'lux', name: "Luminosité", unit: "Lux", def: "--", bar: true },
        { id: 'net_type', name: "Connexion", unit: "", def: "--" },
        { id: 'bat_lvl', name: "Batterie", unit: "%", def: "--", bar: true }
    ];

    const processors = {};
    metrics.forEach(m => processors[m.id] = new SensorProcessor());

    // --- UI ENGINE ---
    const uiRefs = {};
    const grid = document.getElementById('grid');

    metrics.forEach(m => {
        const div = document.createElement('div');
        div.className = 'card';
        div.id = `card-${m.id}`;
        div.innerHTML = `
            <div class="label">${m.name}</div>
            <div class="val-peak" id="p-${m.id}">MAX: --</div>
            <div class="val" id="v-${m.id}">${m.def} <span class="unit">${m.unit}</span></div>
            ${m.bar ? `<div class="bar-container"><div class="bar-fill" id="bar-${m.id}"></div></div>` : ''}
        `;
        grid.appendChild(div);
        uiRefs[m.id] = {
            val: document.getElementById(`v-${m.id}`),
            peak: document.getElementById(`p-${m.id}`),
            bar: document.getElementById(`bar-${m.id}`),
            box: div
        };
    });

    const updateUI = (id, current, displayStr = null, percent = null) => {
        const p = processors[id];
        p.add(current);
        const ref = uiRefs[id];
        if(!ref) return;

        ref.box.className = "card active";
        ref.val.innerHTML = `${displayStr || p.avg.toFixed(2)} <span class="unit">${metrics.find(m=>m.id===id).unit}</span>`;
        ref.peak.innerText = `MAX: ${p.peak.toFixed(2)}`;
        
        if(percent !== null && ref.bar) {
            ref.bar.style.width = Math.min(100, Math.max(0, percent)) + "%";
        }
    };

    // --- CAPTEURS ---
    const startEngine = async () => {
        // 1. Mouvement & G-Force
        window.addEventListener('devicemotion', (e) => {
            const acc = e.acceleration || {x:0, y:0, z:0};
            updateUI('acc_lin', Math.abs(acc.x) + Math.abs(acc.y) + Math.abs(acc.z));

            const accG = e.accelerationIncludingGravity || {x:0, y:0, z:9.8};
            const totalG = Math.sqrt(accG.x**2 + accG.y**2 + accG.z**2) / 9.81;
            updateUI('g_force', totalG, totalG.toFixed(3), (totalG/3)*100);

            const rot = e.rotationRate || {alpha:0, beta:0, gamma:0};
            updateUI('gyro', Math.abs(rot.alpha) + Math.abs(rot.beta));
        });

        // 2. Boussole & Cap (Optimisé)
        let headingSmooth = 0;
        const handleOrient = (e) => {
            let h = e.webkitCompassHeading || (360 - e.alpha) || 0;
            // Correction de la coupure 0/360
            let diff = h - headingSmooth;
            if(diff > 180) diff -= 360;
            if(diff < -180) diff += 360;
            headingSmooth += diff * 0.05; // Lissage très stable

            const finalH = (headingSmooth + 360) % 360;
            document.getElementById('ui-ring').style.transform = `rotate(${-finalH}deg)`;
            document.getElementById('ui-heading').innerText = Math.round(finalH) + "°";
            
            const dirs = ["NORD", "N-EST", "EST", "S-EST", "SUD", "S-OUEST", "OUEST", "N-OUEST"];
            document.getElementById('ui-cardinal').innerText = dirs[Math.round(finalH / 45) % 8];
            document.getElementById('ui-tilt').innerText = `Tilt: ${Math.max(Math.abs(e.beta||0), Math.abs(e.gamma||0)).toFixed(1)}°`;
        };
        window.addEventListener('deviceorientationabsolute', handleOrient, true);
        window.addEventListener('deviceorientation', handleOrient, true);

        // 3. Magnétomètre (API Moderne + Fallback via orientation)
        if ('Magnetometer' in window) {
            try {
                const mag = new Magnetometer({frequency: 20});
                mag.onreading = () => {
                    const total = Math.sqrt(mag.x**2 + mag.y**2 + mag.z**2);
                    updateUI('mag_raw', total, `X:${mag.x.toFixed(1)}\nY:${mag.y.toFixed(1)}`);
                    updateUI('mag_total', total, total.toFixed(1), (total/150)*100);
                };
                mag.start();
            } catch(e) { console.error("Mag API blocked"); }
        }

        // 4. GPS
        navigator.geolocation.watchPosition(p => {
            updateUI('gps_spd', (p.coords.speed || 0) * 3.6);
        }, null, {enableHighAccuracy: true});

        // 5. Réseau (Correction detection type)
        const updateNet = () => {
            const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            const type = conn ? (conn.type || conn.effectiveType || "Inconnu") : "N/A";
            updateUI('net_type', 0, type.toUpperCase());
        };
        if(navigator.connection) navigator.connection.onchange = updateNet;
        updateNet();

        // 6. Batterie
        if(navigator.getBattery) {
            const b = await navigator.getBattery();
            const upB = () => updateUI('bat_lvl', b.level * 100, (b.level * 100).toFixed(0), b.level * 100);
            b.onlevelchange = upB;
            upB();
        }

        initLuxFallback();
    };

    const initLuxFallback = async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({video: {facingMode:'environment'}});
            const v = document.getElementById('hidden-cam');
            v.srcObject = stream;
            const ctx = document.getElementById('lux-canvas').getContext('2d');
            setInterval(() => {
                if(v.readyState === 4) {
                    ctx.drawImage(v, 0, 0, 30, 30);
                    const d = ctx.getImageData(0,0,30,30).data;
                    let light = 0;
                    for(let i=0; i<d.length; i+=4) light += (d[i] + d[i+1] + d[i+2]) / 3;
                    const res = light / (d.length / 4);
                    updateUI('lux', res, Math.round(res), (res/255)*100);
                }
            }, 500);
        } catch(e) {}
    };

    document.getElementById('btn-init').onclick = async () => {
        document.getElementById('btn-init').style.display = 'none';
        if(typeof DeviceOrientationEvent?.requestPermission === 'function') {
            await DeviceOrientationEvent.requestPermission();
            await DeviceMotionEvent.requestPermission();
        }
        startEngine();
    };
}
</script>
</body>
</html>
