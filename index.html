<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ULTIMATE SENSOR FUSION - BOUSSOLE PRO</title>
    <style>
        :root {
            --bg: #000000;
            --card: #111827;
            --accent: #00f0ff;
            --text: #e5e7eb;
            --dim: #6b7280;
            --warn: #facc15;
            --success: #22c55e;
            --north: #ff4757;
        }
        body {
            background: var(--bg); color: var(--text);
            font-family: 'Courier New', Courier, monospace;
            margin: 0; padding: 15px;
            font-size: 12px;
            padding-bottom: 50px;
        }
        h1 { color: var(--accent); text-align: center; border-bottom: 2px solid var(--accent); padding-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 8px;
            margin-top: 20px;
        }

        /* BOUSSOLE RÉVISÉE */
        .instrument.boussole-geante {
            grid-column: 1 / -1;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-around;
            padding: 20px;
            min-height: 140px;
            background: radial-gradient(circle at center, #1e293b 0%, #111827 100%);
        }

        .compass-visual {
            width: 120px;
            height: 120px;
            position: relative;
            /* Le lissage est géré par JS pour plus de contrôle que CSS */
        }

        /* Repère fixe du smartphone (le haut du téléphone) */
        .phone-marker {
            position: absolute;
            top: -10px; left: 50%;
            transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 12px solid var(--accent);
            z-index: 10;
        }

        .instrument {
            background: var(--card);
            border: 1px solid #374151;
            padding: 10px;
            border-radius: 4px;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .instrument.active { border-color: var(--success); box-shadow: 0 0 5px rgba(34, 197, 94, 0.2); }
        .instrument.simulated { border-color: var(--warn); }

        .label { color: var(--accent); font-weight: bold; font-size: 10px; text-transform: uppercase; margin-bottom: 5px; }
        .value { font-size: 14px; font-weight: bold; color: #fff; word-break: break-all; }
        .unit { font-size: 9px; color: var(--dim); margin-top: 2px; }
        .source-tag { position: absolute; top: 5px; right: 5px; font-size: 8px; padding: 2px 4px; border-radius: 2px; background: #374151; color: #fff; }

        #btn-start {
            position: sticky; top: 10px; z-index: 100;
            background: var(--accent); color: #000;
            border: none; padding: 15px; width: 100%;
            font-weight: 900; font-size: 16px;
            border-radius: 4px; cursor: pointer;
            text-transform: uppercase;
            box-shadow: 0 0 20px rgba(0, 240, 255, 0.4);
        }

        #hidden-video { position: fixed; top: -1000px; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

    <h1>Global Sensor Audit</h1>
    <button id="btn-start">ACTIVER LES INSTRUMENTS</button>
    <div id="status-log" style="color: var(--dim); text-align: center; margin-top: 5px;">Calibrage requis...</div>

    <div class="dashboard" id="grid">
        <div class="instrument boussole-geante active" id="box-compass">
            <div class="source-tag" id="src-compass">...</div>
            <div style="position: relative;">
                <div class="phone-marker"></div>
                <div class="compass-visual" id="viz-compass">
                    <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                        <circle cx="50" cy="50" r="48" fill="none" stroke="#374151" stroke-width="1" stroke-dasharray="2 2"/>
                        <text x="50" y="12" fill="var(--north)" font-weight="bold" font-size="10" text-anchor="middle">N</text>
                        <text x="88" y="54" fill="var(--text)" font-weight="bold" font-size="8" text-anchor="middle">E</text>
                        <text x="50" y="94" fill="var(--text)" font-weight="bold" font-size="8" text-anchor="middle">S</text>
                        <text x="12" y="54" fill="var(--text)" font-weight="bold" font-size="8" text-anchor="middle">O</text>
                        <path d="M50 15 L44 50 L50 85 L56 50 Z" fill="var(--north)" stroke="white" stroke-width="0.5"/>
                        <circle cx="50" cy="50" r="3" fill="var(--accent)"/>
                    </svg>
                </div>
            </div>
            <div style="text-align: right;">
                <div class="label">CAP MAGNÉTIQUE</div>
                <div class="value" id="val-compass">--°</div>
                <div class="unit" id="dir-text">Direction: --</div>
            </div>
        </div>
    </div>

    <video id="hidden-video" autoplay playsinline muted></video>
    <canvas id="lux-canvas" width="50" height="50" style="display:none;"></canvas>

<script>
{
    const dataStore = {};
    const uiRefs = {};
    const grid = document.getElementById('grid');
    const log = document.getElementById('status-log');
    const vizCompass = document.getElementById('viz-compass');
    const dirText = document.getElementById('dir-text');

    // Lissage avancé
    let targetHeading = 0;
    let currentHeading = 0;
    const lerpFactor = 0.05; // Très lent pour la précision

    const instruments = [
        { id: 'mag', name: "Magnétomètre X/Y/Z", unit: "µTesla", def: "N/A" },
        { id: 'gyro', name: "Gyroscope", unit: "rad/s", def: "0, 0, 0" },
        { id: 'acc', name: "Accéléromètre", unit: "m/s²", def: "0, 0, 0" },
        { id: 'grav', name: "Gravité", unit: "m/s²", def: "N/A" },
        { id: 'lux', name: "Luminosité", unit: "Lux", def: "--" },
        { id: 'pressure', name: "Baromètre", unit: "hPa", def: "N/A" },
        { id: 'prox', name: "Proximité", unit: "cm", def: "N/A" },
        { id: 'gps', name: "GPS", unit: "Lat/Lon", def: "Attente..." },
        { id: 'alt', name: "Altitude", unit: "M", def: "--" },
        { id: 'speed', name: "Vitesse", unit: "km/h", def: "0" },
        { id: 'net_rtt', name: "Ping", unit: "ms", def: "--" },
        { id: 'net_bw', name: "Bande P.", unit: "Mbps", def: "--" },
        { id: 'bat_level', name: "Batterie", unit: "%", def: "--" },
        { id: 'bat_state', name: "Charge", unit: "Statut", def: "--" },
        { id: 'cpu', name: "CPU", unit: "Threads", def: navigator.hardwareConcurrency || "?" },
        { id: 'ram', name: "RAM", unit: "GiB", def: navigator.deviceMemory || "?" },
        { id: 'touch_f', name: "Touch Force", unit: "0-1", def: "0" },
        { id: 'touch_r', name: "Touch Radius", unit: "Px", def: "0" }
    ];

    uiRefs['compass'] = { val: document.getElementById('val-compass'), src: document.getElementById('src-compass'), box: document.getElementById('box-compass') };

    instruments.forEach(inst => {
        const div = document.createElement('div');
        div.className = 'instrument';
        div.innerHTML = `
            <div class="label">${inst.name}</div>
            <div class="source-tag" id="src-${inst.id}">...</div>
            <div class="value" id="val-${inst.id}">${inst.def}</div>
            <div class="unit">${inst.unit}</div>
        `;
        grid.appendChild(div);
        uiRefs[inst.id] = { val: document.getElementById(`val-${inst.id}`), src: document.getElementById(`src-${inst.id}`), box: div };
    });

    const getCardinal = (angle) => {
        const directions = ["N", "NE", "E", "SE", "S", "SO", "O", "NO"];
        return directions[Math.round(angle / 45) % 8];
    };

    const updateVal = (id, value, source = "API") => {
        if (!uiRefs[id]) return;
        uiRefs[id].val.innerText = value;
        uiRefs[id].src.innerText = source;
        uiRefs[id].box.classList.add(source === "CAM" || source === "Sim" ? "simulated" : "active");
        dataStore[id] = true;
    };

    // Boucle de rendu stabilisée
    const loop = () => {
        let diff = targetHeading - currentHeading;
        if (diff > 180) diff -= 360;
        if (diff < -180) diff += 360;
        currentHeading += diff * lerpFactor;
        
        // Rotation inverse : le cadran reste au Nord, le smartphone bouge
        vizCompass.style.transform = `rotate(${-currentHeading}deg)`;
        
        requestAnimationFrame(loop);
    };

    const initModernSensors = () => {
        const configs = [
            { class: 'Magnetometer', id: 'mag', map: s => `${s.x.toFixed(0)}|${s.y.toFixed(0)}|${s.z.toFixed(0)}`, src: "Hard" },
            { class: 'Accelerometer', id: 'acc', map: s => `${s.x.toFixed(1)}|${s.y.toFixed(1)}|${s.z.toFixed(1)}`, src: "Hard" },
            { class: 'Gyroscope', id: 'gyro', map: s => `${s.x.toFixed(1)}|${s.y.toFixed(1)}|${s.z.toFixed(1)}`, src: "Hard" },
            { class: 'GravitySensor', id: 'grav', map: s => `${s.x.toFixed(1)}|${s.y.toFixed(1)}|${s.z.toFixed(1)}`, src: "Hard" },
            { class: 'PressureSensor', id: 'pressure', map: s => s.pressure.toFixed(1), src: "Hard" }
        ];
        configs.forEach(c => {
            if (c.class in window) {
                try {
                    const s = new window[c.class]({ frequency: 60 });
                    s.onreading = () => updateVal(c.id, c.map(s), c.src);
                    s.start();
                } catch(e) {}
            }
        });
    };

    const initLegacy = () => {
        const handle = (e) => {
            let h = 0;
            let s = "Rel";
            if (e.webkitCompassHeading) { h = e.webkitCompassHeading; s = "iOS"; }
            else if (e.alpha && e.absolute) { h = 360 - e.alpha; s = "Andr"; }
            else if (e.alpha) { h = e.alpha; }

            targetHeading = h;
            updateVal('compass', Math.round(h) + "°", s);
            dirText.innerText = "Direction: " + getCardinal(h);
        };
        window.addEventListener('deviceorientationabsolute', handle, true);
        window.addEventListener('deviceorientation', handle, true);

        if ('geolocation' in navigator) {
            navigator.geolocation.watchPosition(p => {
                updateVal('gps', `${p.coords.latitude.toFixed(4)},${p.coords.longitude.toFixed(4)}`, "GPS");
                updateVal('alt', (p.coords.altitude || 0).toFixed(1), "GPS");
                updateVal('speed', ((p.coords.speed || 0) * 3.6).toFixed(1), "GPS");
            });
        }

        if (navigator.getBattery) {
            navigator.getBattery().then(b => {
                const up = () => { updateVal('bat_level', (b.level * 100).toFixed(0), "API"); updateVal('bat_state', b.charging ? "Charge" : "Secteur", "API"); };
                b.onlevelchange = up; b.onchargingchange = up; up();
            });
        }
    };

    // Fallback Lux via Camera
    const initLux = async () => {
        if ('AmbientLightSensor' in window) {
            const als = new AmbientLightSensor();
            als.onreading = () => updateVal('lux', als.illuminance, "ALS");
            als.start();
        } else {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                const v = document.getElementById('hidden-video');
                const c = document.getElementById('lux-canvas');
                const ctx = c.getContext('2d', {willReadFrequently:true});
                v.srcObject = stream;
                const calc = () => {
                    if (v.readyState === 4) {
                        ctx.drawImage(v, 0,0,50,50);
                        const d = ctx.getImageData(0,0,50,50).data;
                        let s = 0;
                        for(let i=0; i<d.length; i+=16) s += (d[i]*0.299 + d[i+1]*0.587 + d[i+2]*0.114);
                        updateVal('lux', Math.round((s/(d.length/16))*2), "CAM");
                    }
                    requestAnimationFrame(calc);
                };
                calc();
            } catch(e) { updateVal('lux', "N/A", "ERR"); }
        }
    };

    document.getElementById('btn-start').onclick = async () => {
        document.getElementById('btn-start').style.display = 'none';
        if (typeof DeviceOrientationEvent?.requestPermission === 'function') await DeviceOrientationEvent.requestPermission();
        initModernSensors();
        initLegacy();
        initLux();
        requestAnimationFrame(loop);
        log.innerText = "Audit Haute Précision Actif.";
    };
}
</script>
</body>
</html>
