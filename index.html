<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SENSORY PANOPTICON v5.0</title>
    <style>
        :root {
            --bg: #000;
            --card: #0d0d0d;
            --border: #222;
            --accent: #00ff9d;
            --text: #aaa;
            --val: #fff;
            --warn: #ff9d00;
            --dim: #444;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', 'Roboto', 'Monaco', monospace;
            margin: 0;
            padding: 10px;
            font-size: 10px;
            overflow-x: hidden;
            user-select: none;
        }

        header { border-bottom: 2px solid var(--accent); margin-bottom: 15px; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: flex-end; }
        h1 { margin: 0; font-size: 14px; color: var(--accent); letter-spacing: 1px; }
        
        .section-title { color: var(--accent); font-size: 9px; font-weight: bold; text-transform: uppercase; margin: 15px 0 5px 0; display: flex; align-items: center; }
        .section-title::after { content: ""; height: 1px; background: var(--border); flex-grow: 1; margin-left: 10px; }

        .dashboard { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 8px; }

        .card { background: var(--card); border: 1px solid var(--border); border-radius: 4px; padding: 10px; display: flex; flex-direction: column; gap: 6px; cursor: pointer; transition: all 0.2s; position: relative; }
        .card:active { transform: scale(0.98); background: #1a1a1a; }
        .card::after { content: "RESET"; position: absolute; top: 5px; right: 5px; font-size: 7px; color: var(--dim); opacity: 0; }
        .card:hover::after { opacity: 1; }
        
        .card-label { font-size: 8px; font-weight: 800; color: var(--accent); opacity: 0.8; }

        .sensor-table { width: 100%; border-collapse: collapse; }
        .sensor-table th { font-size: 7px; color: var(--dim); text-align: right; padding-bottom: 4px; font-weight: normal; }
        .axis-label { color: var(--dim); font-size: 8px; width: 12px; }
        .v-cur { color: var(--val); font-weight: bold; text-align: right; font-family: monospace; }
        .v-avg { color: var(--text); font-size: 9px; text-align: right; opacity: 0.6; }
        .v-max { color: var(--warn); font-size: 9px; text-align: right; }

        .compass-box { grid-column: 1 / -1; background: #080808; display: flex; align-items: center; padding: 15px; border: 1px solid var(--accent); border-radius: 6px; gap: 20px; }
        .compass-disc { width: 80px; height: 80px; border: 2px solid var(--accent); border-radius: 50%; position: relative; flex-shrink: 0; display: flex; align-items: center; justify-content: center;}
        .compass-needle { width: 2px; height: 40px; background: red; position: absolute; transform-origin: bottom center; bottom: 50%; border-radius: 2px; transition: transform 0.1s linear; }
        .needle-south { width: 2px; height: 40px; background: white; position: absolute; transform-origin: top center; top: 50%; border-radius: 2px; }

        #btn-start { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; color: var(--accent); border: 2px solid var(--accent); cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: #333; display: inline-block; margin-right: 5px; }
        .status-on { background: var(--accent); box-shadow: 0 0 5px var(--accent); }
        #hidden-video { display: none; }
    </style>
</head>
<body>

    <button id="btn-start">
        <span>[ INITIALISER LA MATRICE ]</span>
        <span style="font-size: 10px; margin-top: 10px; font-weight: normal; color: #fff;">Pointez le haut du téléphone vers l'objectif</span>
    </button>

    <header>
        <h1>SENSORY PANOPTICON v5.0</h1>
        <div id="uptime" style="font-size: 9px; color: var(--dim)">UPTIME: 00:00:00</div>
    </header>

    <div class="compass-box">
        <div class="compass-disc" id="ui-compass-reset">
            <div id="needle" class="compass-needle"></div>
            <div id="needle-s" class="needle-south"></div>
            <div style="position:absolute; top:2px; color:red; font-size:8px; font-weight:bold">N</div>
        </div>
        <div style="flex-grow:1">
            <div id="comp-deg" style="font-size: 24px; font-weight: bold; color: #fff;">000°</div>
            <div id="comp-card" style="color: var(--accent); font-size: 10px; letter-spacing: 2px;">--</div>
        </div>
        <div style="text-align: right">
            <div class="card-label">ORIENTATION</div>
            <div id="orient-data" style="font-size: 9px; line-height: 1.4;">α: 0<br>β: 0<br>γ: 0</div>
        </div>
    </div>

    <div class="section-title">Cinématique & Dynamique</div>
    <div class="dashboard">
        <div class="card" onclick="resetSensor('acc')">
            <div class="card-label"><span class="status-dot" id="dot-acc"></span>ACCÉLÉROMÈTRE</div>
            <table class="sensor-table">
                <tr><th></th><th>INST</th><th>LISSÉ</th><th>MAX</th></tr>
                <tr id="row-acc-x"><td class="axis-label">X</td><td class="v-cur">-</td><td class="v-avg">-</td><td class="v-max">-</td></tr>
                <tr id="row-acc-y"><td class="axis-label">Y</td><td class="v-cur">-</td><td class="v-avg">-</td><td class="v-max">-</td></tr>
                <tr id="row-acc-z"><td class="axis-label">Z</td><td class="v-cur">-</td><td class="v-avg">-</td><td class="v-max">-</td></tr>
            </table>
        </div>
        <div class="card" onclick="resetSensor('gyro')">
            <div class="card-label"><span class="status-dot" id="dot-gyro"></span>GYROSCOPE</div>
            <table class="sensor-table">
                <tr><th></th><th>INST</th><th>LISSÉ</th><th>MAX</th></tr>
                <tr id="row-gyro-x"><td class="axis-label">X</td><td class="v-cur">-</td><td class="v-avg">-</td><td class="v-max">-</td></tr>
                <tr id="row-gyro-y"><td class="axis-label">Y</td><td class="v-cur">-</td><td class="v-avg">-</td><td class="v-max">-</td></tr>
                <tr id="row-gyro-z"><td class="axis-label">Z</td><td class="v-cur">-</td><td class="v-avg">-</td><td class="v-max">-</td></tr>
            </table>
        </div>
    </div>

    <div class="section-title">Géolocalisation & Magnétisme</div>
    <div class="dashboard">
        <div class="card" onclick="resetGPS()">
            <div class="card-label">GPS STATS (km/h)</div>
            <table class="sensor-table">
                <tr><th></th><th>INST</th><th>MOY</th><th>MAX</th></tr>
                <tr><td class="axis-label">V</td><td id="gps-spd" class="v-cur">-</td><td id="gps-avg" class="v-avg">-</td><td id="gps-max" class="v-max">-</td></tr>
            </table>
            <div id="gps-pos" style="font-size: 8px; color: var(--dim); margin-top:5px">LAT/LON: --</div>
        </div>
        <div class="card" onclick="resetSensor('mag')">
            <div class="card-label"><span class="status-dot" id="dot-mag"></span>MAGNÉTOMÈTRE</div>
            <table class="sensor-table">
                <tr><th></th><th>INST</th><th>LISSÉ</th><th>MAX</th></tr>
                <tr id="row-mag-x"><td class="axis-label">X</td><td class="v-cur">-</td><td class="v-avg">-</td><td class="v-max">-</td></tr>
                <tr id="row-mag-y"><td class="axis-label">Y</td><td class="v-cur">-</td><td class="v-avg">-</td><td class="v-max">-</td></tr>
                <tr id="row-mag-z"><td class="axis-label">Z</td><td class="v-cur">-</td><td class="v-avg">-</td><td class="v-max">-</td></tr>
            </table>
        </div>
    </div>

    <video id="hidden-video" autoplay playsinline muted></video>
    <canvas id="lux-canvas" width="30" height="30" style="display:none;"></canvas>

<script>
{
    class SensorHub {
        constructor(size = 30) {
            this.size = size;
            this.reset();
        }
        reset() {
            this.axes = {
                x: { cur: 0, buffer: [], max: 0 },
                y: { cur: 0, buffer: [], max: 0 },
                z: { cur: 0, buffer: [], max: 0 }
            };
        }
        push(x, y, z) {
            const vals = { x, y, z };
            for(let a in vals) {
                const v = vals[a] || 0;
                this.axes[a].cur = v;
                this.axes[a].buffer.push(v);
                if(this.axes[a].buffer.length > this.size) this.axes[a].buffer.shift();
                if(Math.abs(v) > Math.abs(this.axes[a].max)) this.axes[a].max = v;
            }
        }
        get(axis) {
            const b = this.axes[axis].buffer;
            const avg = b.reduce((a, b) => a + b, 0) / b.length || 0;
            return {
                cur: this.axes[axis].cur.toFixed(2),
                avg: avg.toFixed(2),
                max: this.axes[axis].max.toFixed(2)
            };
        }
    }

    const hubs = { acc: new SensorHub(), gyro: new SensorHub(), mag: new SensorHub() };

    // GPS Statistique
    const gpsStats = {
        history: [],
        max: 0,
        reset: function() { this.history = []; this.max = 0; }
    };

    window.resetSensor = (id) => hubs[id].reset();
    window.resetGPS = () => gpsStats.reset();

    const updateUI = (type) => {
        document.getElementById(`dot-${type}`).classList.add('status-on');
        ['x', 'y', 'z'].forEach(a => {
            const data = hubs[type].get(a);
            const row = document.getElementById(`row-${type}-${a}`);
            row.querySelector('.v-cur').innerText = data.cur;
            row.querySelector('.v-avg').innerText = data.avg;
            row.querySelector('.v-max').innerText = data.max;
        });
    };

    const run = async () => {
        window.addEventListener('devicemotion', e => {
            const a = e.acceleration || {x:0, y:0, z:0};
            hubs.acc.push(a.x, a.y, a.z); updateUI('acc');
            const g = e.rotationRate || {alpha:0, beta:0, gamma:0};
            hubs.gyro.push(g.alpha, g.beta, g.gamma); updateUI('gyro');
        });

        let sHead = 0;
        window.addEventListener('deviceorientation', e => {
            // Correction : Sur mobile, 0° est le Nord. 
            // On veut que l'aiguille pointe vers le Nord par rapport au haut du mobile.
            let h = e.webkitCompassHeading || (360 - e.alpha) || 0;
            
            let diff = h - sHead;
            if(diff > 180) diff -= 360; if(diff < -180) diff += 360;
            sHead += diff * 0.1;
            const finalH = (sHead + 360) % 360;

            // L'aiguille doit tourner en sens inverse de la rotation du téléphone pour rester fixe au Nord
            document.getElementById('needle').style.transform = `rotate(${-finalH}deg)`;
            document.getElementById('needle-s').style.transform = `rotate(${-finalH}deg)`;
            
            document.getElementById('comp-deg').innerText = Math.round(finalH).toString().padStart(3, '0') + "°";
            document.getElementById('comp-card').innerText = ["NORD", "N-EST", "EST", "S-EST", "SUD", "S-OUEST", "OUEST", "N-OUEST"][Math.round(finalH / 45) % 8];
            document.getElementById('orient-data').innerHTML = `α: ${e.alpha?.toFixed(1)}<br>β: ${e.beta?.toFixed(1)}<br>γ: ${e.gamma?.toFixed(1)}`;
        });

        if ('Magnetometer' in window) {
            try {
                const mag = new Magnetometer({frequency: 20});
                mag.onreading = () => { hubs.mag.push(mag.x, mag.y, mag.z); updateUI('mag'); };
                mag.start();
            } catch(err) {}
        }

        navigator.geolocation.watchPosition(p => {
            const speed = (p.coords.speed || 0) * 3.6; // km/h
            if(speed > 0.5) gpsStats.history.push(speed);
            if(speed > gpsStats.max) gpsStats.max = speed;

            const avg = gpsStats.history.length > 0 
                ? gpsStats.history.reduce((a,b)=>a+b,0) / gpsStats.history.length 
                : 0;

            document.getElementById('gps-spd').innerText = speed.toFixed(1);
            document.getElementById('gps-avg').innerText = avg.toFixed(1);
            document.getElementById('gps-max').innerText = gpsStats.max.toFixed(1);
            document.getElementById('gps-pos').innerText = `${p.coords.latitude.toFixed(4)}, ${p.coords.longitude.toFixed(4)} (±${p.coords.accuracy.toFixed(0)}m)`;
        }, null, {enableHighAccuracy: true});

        const startT = Date.now();
        setInterval(() => {
            const sec = Math.floor((Date.now() - startT) / 1000);
            const h = Math.floor(sec / 3600), m = Math.floor((sec % 3600) / 60), s = sec % 60;
            document.getElementById('uptime').innerText = `UPTIME: ${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }, 1000);
    };

    document.getElementById('btn-start').onclick = async () => {
        document.getElementById('btn-start').style.display = 'none';
        if(typeof DeviceOrientationEvent?.requestPermission === 'function') {
            await DeviceOrientationEvent.requestPermission();
            await DeviceMotionEvent.requestPermission();
        }
        run();
    };
}
</script>
</body>
</html>
