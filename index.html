<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ULTIMATE SENSOR FUSION</title>
    <style>
        :root {
            --bg: #000000;
            --card: #111827;
            --accent: #00f0ff;
            --text: #e5e7eb;
            --dim: #6b7280;
            --warn: #facc15;
            --success: #22c55e;
        }
        body {
            background: var(--bg); color: var(--text);
            font-family: 'Courier New', Courier, monospace;
            margin: 0; padding: 15px;
            font-size: 12px;
            padding-bottom: 50px;
        }
        h1 { color: var(--accent); text-align: center; border-bottom: 2px solid var(--accent); padding-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 8px;
            margin-top: 20px;
        }

        .instrument.boussole-geante {
            grid-column: 1 / -1;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-around;
            padding: 20px;
            min-height: 120px;
        }

        .compass-visual {
            width: 100px;
            height: 100px;
            position: relative;
            /* Transition assouplie pour éviter les sauts brusques */
            transition: transform 0.2s cubic-bezier(0.1, 0.5, 0.1, 1);
        }

        .instrument {
            background: var(--card);
            border: 1px solid #374151;
            padding: 10px;
            border-radius: 4px;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .instrument.active { border-color: var(--success); box-shadow: 0 0 5px rgba(34, 197, 94, 0.2); }
        .instrument.simulated { border-color: var(--warn); }

        .label { color: var(--accent); font-weight: bold; font-size: 10px; text-transform: uppercase; margin-bottom: 5px; }
        .value { font-size: 14px; font-weight: bold; color: #fff; word-break: break-all; }
        .unit { font-size: 9px; color: var(--dim); margin-top: 2px; }
        .source-tag { position: absolute; top: 5px; right: 5px; font-size: 8px; padding: 2px 4px; border-radius: 2px; background: #374151; color: #fff; }

        #btn-start {
            position: sticky; top: 10px; z-index: 100;
            background: var(--accent); color: #000;
            border: none; padding: 15px; width: 100%;
            font-weight: 900; font-size: 16px;
            border-radius: 4px; cursor: pointer;
            text-transform: uppercase;
            box-shadow: 0 0 20px rgba(0, 240, 255, 0.4);
        }

        #hidden-video { position: fixed; top: -1000px; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

    <h1>Global Sensor Audit</h1>
    <button id="btn-start">INITIALISER TOUS LES CAPTEURS</button>
    <div id="status-log" style="color: var(--dim); text-align: center; margin-top: 5px;">En attente d'activation...</div>

    <div class="dashboard" id="grid">
        <div class="instrument boussole-geante active" id="box-compass">
            <div class="source-tag" id="src-compass">...</div>
            <div class="compass-visual" id="viz-compass">
                <svg viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="48" fill="none" stroke="#374151" stroke-width="2"/>
                    <text x="50" y="15" fill="#ff4757" font-weight="bold" font-size="12" text-anchor="middle">N</text>
                    <path d="M50 20 L40 50 L50 80 L60 50 Z" fill="#ff4757" />
                    <path d="M50 50 L40 50 L50 80 L60 50 Z" fill="#00f0ff" opacity="0.5" />
                </svg>
            </div>
            <div style="text-align: right;">
                <div class="label">Orientation Smartphone</div>
                <div class="value" id="val-compass">--°</div>
                <div class="unit">Degrés (Nord)</div>
            </div>
        </div>
    </div>

    <video id="hidden-video" autoplay playsinline muted></video>
    <canvas id="lux-canvas" width="50" height="50" style="display:none;"></canvas>

<script>
{
    const dataStore = {};
    const uiRefs = {};
    const grid = document.getElementById('grid');
    const log = document.getElementById('status-log');
    const vizCompass = document.getElementById('viz-compass');

    // Variables pour le lissage de la boussole
    let targetHeading = 0;
    let smoothedHeading = 0;
    const smoothingFactor = 0.08; // Plus bas = plus lent/précis

    const instruments = [
        { id: 'mag', name: "Magnétomètre X/Y/Z", unit: "µTesla", def: "N/A" },
        { id: 'gyro', name: "Gyroscope", unit: "rad/s", def: "0, 0, 0" },
        { id: 'acc', name: "Accéléromètre", unit: "m/s²", def: "0, 0, 0" },
        { id: 'grav', name: "Gravité", unit: "m/s²", def: "N/A" },
        { id: 'lux', name: "Luminosité", unit: "Lux", def: "--" },
        { id: 'pressure', name: "Baromètre", unit: "hPa", def: "N/A" },
        { id: 'prox', name: "Proximité", unit: "cm", def: "N/A" },
        { id: 'gps', name: "Coordonnées GPS", unit: "Lat/Lon", def: "Attente..." },
        { id: 'alt', name: "Altitude GPS", unit: "Mètres", def: "--" },
        { id: 'speed', name: "Vitesse GPS", unit: "km/h", def: "0" },
        { id: 'net_rtt', name: "Ping (RTT)", unit: "ms", def: "--" },
        { id: 'net_bw', name: "Bande Passante", unit: "Mbps", def: "--" },
        { id: 'bat_level', name: "Batterie", unit: "%", def: "--" },
        { id: 'bat_state', name: "État Charge", unit: "Statut", def: "--" },
        { id: 'cpu', name: "Cœurs CPU", unit: "Threads", def: navigator.hardwareConcurrency || "?" },
        { id: 'ram', name: "Mémoire RAM", unit: "GiB", def: navigator.deviceMemory || "?" },
        { id: 'touch_f', name: "Pression Doigt", unit: "Force (0-1)", def: "0" },
        { id: 'touch_r', name: "Surface Doigt", unit: "Radius Px", def: "0" }
    ];

    uiRefs['compass'] = { val: document.getElementById('val-compass'), src: document.getElementById('src-compass'), box: document.getElementById('box-compass') };

    instruments.forEach(inst => {
        const div = document.createElement('div');
        div.className = 'instrument';
        div.innerHTML = `
            <div class="label">${inst.name}</div>
            <div class="source-tag" id="src-${inst.id}">...</div>
            <div class="value" id="val-${inst.id}">${inst.def}</div>
            <div class="unit">${inst.unit}</div>
        `;
        grid.appendChild(div);
        uiRefs[inst.id] = { val: document.getElementById(`val-${inst.id}`), src: document.getElementById(`src-${inst.id}`), box: div };
    });

    const updateVal = (id, value, source = "API") => {
        if (!uiRefs[id]) return;
        uiRefs[id].val.innerText = value;
        uiRefs[id].src.innerText = source;
        uiRefs[id].box.classList.add(source === "CAM" || source === "Sim" ? "simulated" : "active");
        dataStore[id] = true;
    };

    // Boucle de rendu pour la fluidité graphique (Lerp)
    const animateCompass = () => {
        // Calcul du plus court chemin circulaire
        let diff = targetHeading - smoothedHeading;
        if (diff > 180) diff -= 360;
        if (diff < -180) diff += 360;
        
        smoothedHeading += diff * smoothingFactor;
        vizCompass.style.transform = `rotate(${-smoothedHeading}deg)`;
        requestAnimationFrame(animateCompass);
    };

    const initModernSensors = () => {
        const sensors = [
            { class: 'Magnetometer', id: 'mag', map: s => `${s.x.toFixed(0)}|${s.y.toFixed(0)}|${s.z.toFixed(0)}`, src: "Hard" },
            { class: 'Accelerometer', id: 'acc', map: s => `${s.x.toFixed(1)}|${s.y.toFixed(1)}|${s.z.toFixed(1)}`, src: "Hard" },
            { class: 'Gyroscope', id: 'gyro', map: s => `${s.x.toFixed(1)}|${s.y.toFixed(1)}|${s.z.toFixed(1)}`, src: "Hard" },
            { class: 'GravitySensor', id: 'grav', map: s => `${s.x.toFixed(1)}|${s.y.toFixed(1)}|${s.z.toFixed(1)}`, src: "Hard" },
            { class: 'PressureSensor', id: 'pressure', map: s => s.pressure.toFixed(1), src: "Hard" },
            { class: 'ProximitySensor', id: 'prox', map: s => s.distance, src: "Hard" }
        ];

        sensors.forEach(conf => {
            if (conf.class in window) {
                try {
                    const s = new window[conf.class]({ frequency: 60 });
                    s.addEventListener('reading', () => updateVal(conf.id, conf.map(s), conf.src));
                    s.start();
                } catch(e) {}
            }
        });

        if ('AmbientLightSensor' in window) {
            try {
                const als = new AmbientLightSensor();
                als.onreading = () => updateVal('lux', als.illuminance, "ALS");
                als.start();
            } catch(e) { startCameraLuxFallback(); }
        } else {
            startCameraLuxFallback();
        }
    };

    const initLegacyAndSystem = () => {
        const handleOrient = (e) => {
            let heading = 0;
            let src = "N/A";
            if (e.webkitCompassHeading) { heading = e.webkitCompassHeading; src = "iOS"; }
            else if (e.alpha && e.absolute) { heading = 360 - e.alpha; src = "Andr"; }
            else if (e.alpha) { heading = e.alpha; src = "Rel"; }

            targetHeading = heading; // On met à jour la cible
            updateVal('compass', Math.round(heading) + "°", src);

            if (!dataStore['mag']) {
                updateVal('mag', `${(e.beta||0).toFixed(0)}|${(e.gamma||0).toFixed(0)}|?`, "Sim");
            }
        };
        window.addEventListener('deviceorientationabsolute', handleOrient, true);
        window.addEventListener('deviceorientation', handleOrient, true);

        window.addEventListener('devicemotion', (e) => {
            if (!dataStore['acc']) {
                const a = e.accelerationIncludingGravity || e.acceleration;
                if(a) updateVal('acc', `${(a.x||0).toFixed(1)}|${(a.y||0).toFixed(1)}|${(a.z||0).toFixed(1)}`, "Evt");
            }
        });

        if ('geolocation' in navigator) {
            navigator.geolocation.watchPosition(p => {
                updateVal('gps', `${p.coords.latitude.toFixed(4)}, ${p.coords.longitude.toFixed(4)}`, "GPS");
                if(p.coords.altitude) updateVal('alt', p.coords.altitude.toFixed(1), "GPS");
                if(p.coords.speed) updateVal('speed', (p.coords.speed * 3.6).toFixed(1), "GPS");
            }, null, { enableHighAccuracy: true });
        }

        if (navigator.getBattery) {
            navigator.getBattery().then(b => {
                const up = () => { updateVal('bat_level', (b.level * 100).toFixed(0), "API"); updateVal('bat_state', b.charging ? "Charge" : "Secteur", "API"); };
                b.onlevelchange = up; b.onchargingchange = up; up();
            });
        }

        if (navigator.connection) {
            const upNet = () => { updateVal('net_rtt', navigator.connection.rtt || "?", "Net"); updateVal('net_bw', navigator.connection.downlink || "?", "Net"); };
            navigator.connection.onchange = upNet; upNet();
        }

        window.addEventListener('touchmove', (e) => {
            const t = e.touches[0];
            updateVal('touch_f', (t.force || 0).toFixed(2), "Tch");
            updateVal('touch_r', (t.radiusX || 1).toFixed(1), "Tch");
        }, {passive: true});
    };

    const startCameraLuxFallback = async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            const video = document.getElementById('hidden-video');
            const canvas = document.getElementById('lux-canvas');
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            video.srcObject = stream;
            const computeLux = () => {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    ctx.drawImage(video, 0, 0, 50, 50);
                    const p = ctx.getImageData(0, 0, 50, 50).data;
                    let sum = 0;
                    for(let i=0; i<p.length; i+=16) { sum += (p[i]*0.299 + p[i+1]*0.587 + p[i+2]*0.114); }
                    updateVal('lux', Math.round((sum / (p.length / 16)) * 2), "CAM"); 
                }
                requestAnimationFrame(computeLux);
            };
            computeLux();
        } catch(e) { updateVal('lux', "Bloqué", "ERR"); }
    };

    document.getElementById('btn-start').onclick = async () => {
        document.getElementById('btn-start').style.display = 'none';
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            try { await DeviceOrientationEvent.requestPermission(); } catch(e) {}
        }
        initModernSensors();
        initLegacyAndSystem();
        animateCompass(); // Lance la boucle de lissage
        log.innerText = "Audit stabilisé actif.";
    };
}
</script>
</body>
</html>
